// üì° Event Bus - –ì–ª–æ–±–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—ñ–π

class EventBus {
    constructor() {
        this.events = new Map();
        this.onceEvents = new Map();
        this.wildcardListeners = [];
        this.history = [];
        this.maxHistorySize = 100;
        this.isEnabled = true;
        this.debugMode = false;
        
        this.init();
    }

    // ========================================
    // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    // ========================================

    init() {
        // –ì–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è listeners
        this.errorHandler = (error, eventName, listener) => {
            console.error(`‚ùå EventBus error in "${eventName}":`, error);
            
            if (window.errorHandler) {
                errorHandler.logError({
                    type: 'event_bus_error',
                    message: `Event listener error: ${eventName}`,
                    error: error.message,
                    stack: error.stack,
                    severity: 'medium',
                    context: 'EventBus'
                });
            }
        };

        console.log('‚úÖ Event Bus initialized');
    }

    // ========================================
    // –ü–Ü–î–ü–ò–°–ö–ê –ù–ê –ü–û–î–Ü–á
    // ========================================

    /**
     * –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –ø–æ–¥—ñ—é
     * @param {string} eventName - –ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó
     * @param {Function} callback - –§—É–Ω–∫—Ü—ñ—è-–æ–±—Ä–æ–±–Ω–∏–∫
     * @param {Object} options - –û–ø—Ü—ñ—ó (priority, context)
     * @returns {Function} - –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø–∏—Å–∫–∏
     */
    on(eventName, callback, options = {}) {
        if (!eventName || typeof callback !== 'function') {
            console.error('EventBus.on: Invalid arguments');
            return () => {};
        }

        if (!this.events.has(eventName)) {
            this.events.set(eventName, []);
        }

        const listener = {
            callback,
            priority: options.priority || 0,
            context: options.context || null,
            id: this.generateListenerId()
        };

        const listeners = this.events.get(eventName);
        listeners.push(listener);

        // –°–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º (–≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç - –ø–µ—Ä—à–∏–π)
        listeners.sort((a, b) => b.priority - a.priority);

        if (this.debugMode) {
            console.log(`üì° Subscribed to "${eventName}" (priority: ${listener.priority})`);
        }

        // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –≤—ñ–¥–ø–∏—Å–∫–∏
        return () => this.off(eventName, callback);
    }

    /**
     * –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –ø–æ–¥—ñ—é (—Å–ø—Ä–∞—Ü—é—î –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑)
     * @param {string} eventName - –ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó
     * @param {Function} callback - –§—É–Ω–∫—Ü—ñ—è-–æ–±—Ä–æ–±–Ω–∏–∫
     * @param {Object} options - –û–ø—Ü—ñ—ó
     * @returns {Function} - –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø–∏—Å–∫–∏
     */
    once(eventName, callback, options = {}) {
        if (!eventName || typeof callback !== 'function') {
            console.error('EventBus.once: Invalid arguments');
            return () => {};
        }

        if (!this.onceEvents.has(eventName)) {
            this.onceEvents.set(eventName, []);
        }

        const listener = {
            callback,
            priority: options.priority || 0,
            context: options.context || null,
            id: this.generateListenerId()
        };

        this.onceEvents.get(eventName).push(listener);

        if (this.debugMode) {
            console.log(`üì° Subscribed to "${eventName}" (once)`);
        }

        return () => this.offOnce(eventName, callback);
    }

    /**
     * –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –≤—Å—ñ –ø–æ–¥—ñ—ó (wildcard)
     * @param {Function} callback - –§—É–Ω–∫—Ü—ñ—è-–æ–±—Ä–æ–±–Ω–∏–∫
     * @returns {Function} - –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø–∏—Å–∫–∏
     */
    onAny(callback) {
        if (typeof callback !== 'function') {
            console.error('EventBus.onAny: Invalid callback');
            return () => {};
        }

        this.wildcardListeners.push(callback);

        if (this.debugMode) {
            console.log('üì° Subscribed to all events (wildcard)');
        }

        return () => {
            const index = this.wildcardListeners.indexOf(callback);
            if (index > -1) {
                this.wildcardListeners.splice(index, 1);
            }
        };
    }

    // ========================================
    // –í–Ü–î–ü–ò–°–ö–ê
    // ========================================

    /**
     * –í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –≤—ñ–¥ –ø–æ–¥—ñ—ó
     * @param {string} eventName - –ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó
     * @param {Function} callback - –§—É–Ω–∫—Ü—ñ—è-–æ–±—Ä–æ–±–Ω–∏–∫
     */
    off(eventName, callback) {
        if (!this.events.has(eventName)) return;

        const listeners = this.events.get(eventName);
        const index = listeners.findIndex(l => l.callback === callback);

        if (index > -1) {
            listeners.splice(index, 1);

            if (this.debugMode) {
                console.log(`üì° Unsubscribed from "${eventName}"`);
            }
        }

        // –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Å–∏–≤ —è–∫—â–æ –ø–æ—Ä–æ–∂–Ω—ñ–π
        if (listeners.length === 0) {
            this.events.delete(eventName);
        }
    }

    /**
     * –í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –≤—ñ–¥ once –ø–æ–¥—ñ—ó
     */
    offOnce(eventName, callback) {
        if (!this.onceEvents.has(eventName)) return;

        const listeners = this.onceEvents.get(eventName);
        const index = listeners.findIndex(l => l.callback === callback);

        if (index > -1) {
            listeners.splice(index, 1);
        }

        if (listeners.length === 0) {
            this.onceEvents.delete(eventName);
        }
    }

    /**
     * –í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –≤—ñ–¥ –≤—Å—ñ—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ—ó
     * @param {string} eventName - –ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó
     */
    offAll(eventName) {
        if (eventName) {
            this.events.delete(eventName);
            this.onceEvents.delete(eventName);

            if (this.debugMode) {
                console.log(`üì° Removed all listeners for "${eventName}"`);
            }
        } else {
            // –í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –≤—ñ–¥ –í–°–Ü–• –ø–æ–¥—ñ–π
            this.events.clear();
            this.onceEvents.clear();
            this.wildcardListeners = [];

            if (this.debugMode) {
                console.log('üì° Removed ALL listeners');
            }
        }
    }

    // ========================================
    // –í–ò–ü–†–û–ú–Ü–ù–Æ–í–ê–ù–ù–Ø –ü–û–î–Ü–ô
    // ========================================

    /**
     * –í–∏–ø—Ä–æ–º—ñ–Ω–∏—Ç–∏ –ø–æ–¥—ñ—é
     * @param {string} eventName - –ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó
     * @param {*} data - –î–∞–Ω—ñ –ø–æ–¥—ñ—ó
     * @param {Object} options - –û–ø—Ü—ñ—ó (async)
     */
    emit(eventName, data = {}, options = {}) {
        if (!this.isEnabled) return;

        if (!eventName) {
            console.error('EventBus.emit: Event name is required');
            return;
        }

        // –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
        this.addToHistory(eventName, data);

        if (this.debugMode) {
            console.log(`üì° Emitting "${eventName}"`, data);
        }

        // –í–∏–∫–ª–∏–∫–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        if (options.async) {
            this.emitAsync(eventName, data);
        } else {
            this.emitSync(eventName, data);
        }
    }

    /**
     * –°–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –≤–∏–ø—Ä–æ–º—ñ–Ω—é–≤–∞–Ω–Ω—è
     */
    emitSync(eventName, data) {
        // 1. Wildcard listeners
        this.wildcardListeners.forEach(callback => {
            this.executeListener(callback, eventName, data);
        });

        // 2. Once listeners
        if (this.onceEvents.has(eventName)) {
            const onceListeners = [...this.onceEvents.get(eventName)];
            this.onceEvents.delete(eventName);

            onceListeners.forEach(listener => {
                this.executeListener(listener.callback, eventName, data, listener.context);
            });
        }

        // 3. Regular listeners
        if (this.events.has(eventName)) {
            const listeners = this.events.get(eventName);
            
            listeners.forEach(listener => {
                this.executeListener(listener.callback, eventName, data, listener.context);
            });
        }
    }

    /**
     * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –≤–∏–ø—Ä–æ–º—ñ–Ω—é–≤–∞–Ω–Ω—è
     */
    async emitAsync(eventName, data) {
        // Wildcard
        await Promise.all(
            this.wildcardListeners.map(callback => 
                this.executeListenerAsync(callback, eventName, data)
            )
        );

        // Once
        if (this.onceEvents.has(eventName)) {
            const onceListeners = [...this.onceEvents.get(eventName)];
            this.onceEvents.delete(eventName);

            await Promise.all(
                onceListeners.map(listener =>
                    this.executeListenerAsync(listener.callback, eventName, data, listener.context)
                )
            );
        }

        // Regular
        if (this.events.has(eventName)) {
            const listeners = this.events.get(eventName);
            
            await Promise.all(
                listeners.map(listener =>
                    this.executeListenerAsync(listener.callback, eventName, data, listener.context)
                )
            );
        }
    }

    /**
     * –í–∏–∫–æ–Ω–∞—Ç–∏ listener
     */
    executeListener(callback, eventName, data, context = null) {
        try {
            if (context) {
                callback.call(context, data, eventName);
            } else {
                callback(data, eventName);
            }
        } catch (error) {
            this.errorHandler(error, eventName, callback);
        }
    }

    /**
     * –í–∏–∫–æ–Ω–∞—Ç–∏ listener –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
     */
    async executeListenerAsync(callback, eventName, data, context = null) {
        try {
            if (context) {
                await callback.call(context, data, eventName);
            } else {
                await callback(data, eventName);
            }
        } catch (error) {
            this.errorHandler(error, eventName, callback);
        }
    }

    // ========================================
    // UTILITY –ú–ï–¢–û–î–ò
    // ========================================

    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –ø–æ–¥—ñ—ó
     */
    hasListeners(eventName) {
        return (
            (this.events.has(eventName) && this.events.get(eventName).length > 0) ||
            (this.onceEvents.has(eventName) && this.onceEvents.get(eventName).length > 0) ||
            this.wildcardListeners.length > 0
        );
    }

    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
     */
    getListenerCount(eventName) {
        let count = 0;

        if (this.events.has(eventName)) {
            count += this.events.get(eventName).length;
        }

        if (this.onceEvents.has(eventName)) {
            count += this.onceEvents.get(eventName).length;
        }

        return count;
    }

    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –Ω–∞–∑–≤–∏ –ø–æ–¥—ñ–π
     */
    getEventNames() {
        const names = new Set([
            ...this.events.keys(),
            ...this.onceEvents.keys()
        ]);

        return Array.from(names);
    }

    /**
     * –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ EventBus
     */
    enable() {
        this.isEnabled = true;
        console.log('üì° EventBus enabled');
    }

    disable() {
        this.isEnabled = false;
        console.log('üì° EventBus disabled');
    }

    /**
     * –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ debug —Ä–µ–∂–∏–º
     */
    setDebug(enabled) {
        this.debugMode = enabled;
        console.log(`üì° EventBus debug mode: ${enabled ? 'ON' : 'OFF'}`);
    }

    // ========================================
    // –Ü–°–¢–û–†–Ü–Ø –ü–û–î–Ü–ô
    // ========================================

    addToHistory(eventName, data) {
        this.history.unshift({
            eventName,
            data,
            timestamp: Date.now(),
            date: new Date().toISOString()
        });

        // –û–±–º–µ–∂–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä —ñ—Å—Ç–æ—Ä—ñ—ó
        if (this.history.length > this.maxHistorySize) {
            this.history = this.history.slice(0, this.maxHistorySize);
        }
    }

    getHistory(eventName = null, limit = 10) {
        if (eventName) {
            return this.history
                .filter(entry => entry.eventName === eventName)
                .slice(0, limit);
        }

        return this.history.slice(0, limit);
    }

    clearHistory() {
        this.history = [];
        console.log('üì° EventBus history cleared');
    }

    // ========================================
    // HELPER –ú–ï–¢–û–î–ò
    // ========================================

    generateListenerId() {
        return `listener_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // ========================================
    // –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê
    // ========================================

    getStats() {
        const eventNames = this.getEventNames();
        
        const stats = {
            totalEvents: eventNames.length,
            totalListeners: 0,
            wildcardListeners: this.wildcardListeners.length,
            historySize: this.history.length,
            isEnabled: this.isEnabled,
            debugMode: this.debugMode,
            events: {}
        };

        eventNames.forEach(name => {
            const count = this.getListenerCount(name);
            stats.totalListeners += count;
            stats.events[name] = count;
        });

        return stats;
    }

    debug() {
        const stats = this.getStats();

        console.group('üì° EventBus Debug Info');
        console.log('Status:', this.isEnabled ? '‚úÖ Enabled' : '‚ùå Disabled');
        console.log('Debug Mode:', this.debugMode ? 'ON' : 'OFF');
        console.log('Total Events:', stats.totalEvents);
        console.log('Total Listeners:', stats.totalListeners);
        console.log('Wildcard Listeners:', stats.wildcardListeners);
        console.log('History Size:', stats.historySize);
        console.log('\nEvents:');
        console.table(stats.events);
        console.log('\nRecent History:');
        console.table(this.getHistory(null, 5));
        console.groupEnd();
    }

    // ========================================
    // –ü–†–ï–î–ï–§–Ü–ù–û–í–ê–ù–Ü –ü–û–î–Ü–á
    // ========================================

    /**
     * –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –ø–æ–¥—ñ—ó —Å–∏—Å—Ç–µ–º–∏
     */
    static get Events() {
        return {
            // App lifecycle
            APP_READY: 'app:ready',
            APP_ERROR: 'app:error',
            
            // Mode changes
            MODE_CHANGE: 'mode:change',
            MODE_BEFORE_CHANGE: 'mode:beforeChange',
            
            // Chat events
            MESSAGE_SEND: 'chat:send',
            MESSAGE_RECEIVE: 'chat:receive',
            CHAT_CLEAR: 'chat:clear',
            
            // Code events
            CODE_GENERATE: 'code:generate',
            CODE_UPDATE: 'code:update',
            CODE_DELETE: 'code:delete',
            FILE_SWITCH: 'code:fileSwitch',
            
            // Image events
            IMAGE_GENERATE: 'image:generate',
            IMAGE_READY: 'image:ready',
            
            // Storage events
            DATA_SAVE: 'storage:save',
            DATA_LOAD: 'storage:load',
            DATA_DELETE: 'storage:delete',
            
            // UI events
            THEME_CHANGE: 'ui:themeChange',
            SIDEBAR_TOGGLE: 'ui:sidebarToggle',
            MODAL_OPEN: 'ui:modalOpen',
            MODAL_CLOSE: 'ui:modalClose',
            
            // Agent events
            AGENT_ACTIVE: 'agent:active',
            TASK_ADD: 'agent:taskAdd',
            TASK_COMPLETE: 'agent:taskComplete',
            MEMORY_ADD: 'agent:memoryAdd',
            
            // Error events
            ERROR_OCCURRED: 'error:occurred',
            API_ERROR: 'error:api',
            STORAGE_ERROR: 'error:storage'
        };
    }
}

// ========================================
// –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –ï–ö–ó–ï–ú–ü–õ–Ø–†
// ========================================

const eventBus = new EventBus();

// –ï–∫—Å–ø–æ—Ä—Ç
window.eventBus = eventBus;
window.EventBusEvents = EventBus.Events;

// ========================================
// –Ü–ù–¢–ï–ì–†–ê–¶–Ü–Ø –ó APPSTATE
// ========================================

// –Ø–∫—â–æ appState –≤–∂–µ —ñ—Å–Ω—É—î - –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ EventBus
if (window.appState) {
    const originalNotify = appState.notify.bind(appState);
    
    appState.notify = function(event, data) {
        // –í–∏–∫–ª–∏–∫–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π notify
        originalNotify(event, data);
        
        // –¢–∞–∫–æ–∂ –≤–∏–ø—Ä–æ–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–µ–∑ EventBus
        eventBus.emit(event, data);
    };
    
    console.log('‚úÖ EventBus integrated with AppState');
}

// ========================================
// HELPER –§–£–ù–ö–¶–Ü–á
// ========================================

/**
 * –®–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –ø–æ–¥—ñ–π
 */
window.on = (event, callback, options) => eventBus.on(event, callback, options);
window.once = (event, callback, options) => eventBus.once(event, callback, options);
window.emit = (event, data, options) => eventBus.emit(event, data, options);
window.off = (event, callback) => eventBus.off(event, callback);

console.log('‚úÖ Event Bus loaded');
