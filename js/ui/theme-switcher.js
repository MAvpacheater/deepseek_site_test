// üé® Theme Switcher - –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ–º–∞–º–∏ (FIXED)

class ThemeSwitcher {
    constructor() {
        this.currentTheme = 'dark';
        this.themes = {
            dark: {
                name: '–¢–µ–º–Ω–∞',
                icon: 'üåô'
            },
            light: {
                name: '–°–≤—ñ—Ç–ª–∞',
                icon: '‚òÄÔ∏è'
            }
        };
    }

    // ========================================
    // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    // ========================================

    init() {
        this.loadTheme();
        this.setupListeners();
        console.log('‚úÖ Theme Switcher initialized');
    }

    loadTheme() {
        try {
            // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ appState
            if (window.appState && window.appState.ui && window.appState.ui.theme) {
                this.currentTheme = appState.ui.theme;
            } else {
                // Fallback –¥–æ localStorage
                const saved = localStorage.getItem('theme');
                if (saved && this.themes[saved]) {
                    this.currentTheme = saved;
                } else {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—É —Ç–µ–º—É —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        this.currentTheme = 'dark';
                    } else {
                        this.currentTheme = 'dark'; // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                    }
                }
            }

            this.applyTheme(this.currentTheme, false);
        } catch (error) {
            console.error('Error loading theme:', error);
            this.currentTheme = 'dark';
            this.applyTheme('dark', false);
        }
    }

    setupListeners() {
        try {
            // –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –∑–º—ñ–Ω–∏ –≤ appState
            if (window.appState && typeof appState.on === 'function') {
                appState.on('theme:change', ({ theme }) => {
                    this.applyTheme(theme, false);
                });
            }

            // –í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
            if (window.matchMedia) {
                const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ addEventListener —è–∫—â–æ —î, —ñ–Ω–∞–∫—à–µ addListener
                if (darkModeQuery.addEventListener) {
                    darkModeQuery.addEventListener('change', (e) => {
                        if (!localStorage.getItem('theme')) {
                            this.setTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                } else if (darkModeQuery.addListener) {
                    darkModeQuery.addListener((e) => {
                        if (!localStorage.getItem('theme')) {
                            this.setTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error setting up theme listeners:', error);
        }
    }

    // ========================================
    // –ó–ê–°–¢–û–°–£–í–ê–¢–ò –¢–ï–ú–£
    // ========================================

    applyTheme(theme, save = true) {
        try {
            if (!this.themes[theme]) {
                console.warn(`Unknown theme: ${theme}`);
                return false;
            }

            this.currentTheme = theme;

            // –û–Ω–æ–≤–∏—Ç–∏ body class
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }

            // –û–Ω–æ–≤–∏—Ç–∏ meta theme-color
            this.updateMetaThemeColor(theme);

            // –û–Ω–æ–≤–∏—Ç–∏ —ñ–∫–æ–Ω–∫—É
            this.updateThemeIcon(theme);

            // –ó–±–µ—Ä–µ–≥—Ç–∏
            if (save) {
                try {
                    if (window.appState && typeof appState.setTheme === 'function') {
                        appState.setTheme(theme);
                    } else {
                        localStorage.setItem('theme', theme);
                    }
                } catch (error) {
                    console.error('Error saving theme:', error);
                    localStorage.setItem('theme', theme);
                }
            }

            // Dispatch event
            try {
                window.dispatchEvent(new CustomEvent('themechange', { detail: { theme } }));
            } catch (error) {
                console.error('Error dispatching theme event:', error);
            }

            return true;
        } catch (error) {
            console.error('Error applying theme:', error);
            return false;
        }
    }

    // ========================================
    // –ü–ï–†–ï–ú–ö–ù–£–¢–ò –¢–ï–ú–£
    // ========================================

    toggle() {
        const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        return this.setTheme(newTheme);
    }

    setTheme(theme) {
        return this.applyTheme(theme, true);
    }

    // ========================================
    // UI UPDATES
    // ========================================

    updateThemeIcon(theme) {
        try {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = this.themes[theme].icon;
            }

            // –û–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ theme buttons
            document.querySelectorAll('[data-theme-toggle]').forEach(btn => {
                try {
                    btn.textContent = this.themes[theme].icon;
                    btn.title = `–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –Ω–∞ ${theme === 'dark' ? '—Å–≤—ñ—Ç–ª—É' : '—Ç–µ–º–Ω—É'} —Ç–µ–º—É`;
                } catch (error) {
                    console.error('Error updating theme button:', error);
                }
            });
        } catch (error) {
            console.error('Error updating theme icon:', error);
        }
    }

    updateMetaThemeColor(theme) {
        try {
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            
            if (!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = 'theme-color';
                document.head.appendChild(metaTheme);
            }

            const colors = {
                dark: '#0d1117',
                light: '#ffffff'
            };

            metaTheme.content = colors[theme] || colors.dark;
        } catch (error) {
            console.error('Error updating meta theme color:', error);
        }
    }

    // ========================================
    // GETTERS
    // ========================================

    getCurrentTheme() {
        return this.currentTheme;
    }

    getThemeName() {
        return this.themes[this.currentTheme]?.name || '–¢–µ–º–Ω–∞';
    }

    getThemeIcon() {
        return this.themes[this.currentTheme]?.icon || 'üåô';
    }

    isDark() {
        return this.currentTheme === 'dark';
    }

    isLight() {
        return this.currentTheme === 'light';
    }

    // ========================================
    // AUTO THEME (–∑–∞ —Å–∏—Å—Ç–µ–º–æ—é)
    // ========================================

    enableAutoTheme() {
        if (!window.matchMedia) {
            console.warn('matchMedia not supported');
            return false;
        }

        try {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            this.setTheme(prefersDark ? 'dark' : 'light');
            
            // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ localStorage —â–æ–± auto theme –ø—Ä–∞—Ü—é–≤–∞–ª–∞
            localStorage.removeItem('theme');
            
            return true;
        } catch (error) {
            console.error('Error enabling auto theme:', error);
            return false;
        }
    }

    disableAutoTheme() {
        try {
            // –ü—Ä–æ—Å—Ç–æ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω—É —Ç–µ–º—É
            localStorage.setItem('theme', this.currentTheme);
            return true;
        } catch (error) {
            console.error('Error disabling auto theme:', error);
            return false;
        }
    }

    // ========================================
    // TRANSITION ANIMATION
    // ========================================

    setThemeWithTransition(theme) {
        try {
            // –î–æ–¥–∞—Ç–∏ transition class
            document.documentElement.classList.add('theme-transition');

            // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ç–µ–º—É
            this.setTheme(theme);

            // –í–∏–¥–∞–ª–∏—Ç–∏ transition –ø—ñ—Å–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
            setTimeout(() => {
                document.documentElement.classList.remove('theme-transition');
            }, 300);
        } catch (error) {
            console.error('Error setting theme with transition:', error);
            this.setTheme(theme);
        }
    }

    // ========================================
    // DEBUG
    // ========================================

    debug() {
        console.group('üé® Theme Switcher Debug');
        console.log('Current theme:', this.currentTheme);
        console.log('Theme name:', this.getThemeName());
        console.log('Is dark:', this.isDark());
        console.log('Body classes:', Array.from(document.body.classList));
        console.log('Saved theme:', localStorage.getItem('theme'));
        
        if (window.appState && window.appState.ui) {
            console.log('AppState theme:', appState.ui.theme);
        }
        
        console.groupEnd();
    }
}

// ========================================
// –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
// ========================================

const themeSwitcher = new ThemeSwitcher();

// –ï–∫—Å–ø–æ—Ä—Ç
window.themeSwitcher = themeSwitcher;

// Backward compatibility
window.toggleTheme = () => themeSwitcher.toggle();
window.setTheme = (theme) => themeSwitcher.setTheme(theme);

console.log('‚úÖ Theme Switcher loaded');
