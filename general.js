// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
let codeFiles = {};
let activeFile = null;
let currentMode = 'gemini';

let geminiHistory = [];
let deepseekHistory = [];

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
window.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    initializeInputs();
});

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
function loadSettings() {
    const geminiKey = localStorage.getItem('gemini_api_key') || '';
    const groqKey = localStorage.getItem('groq_api_key') || '';
    const geminiPrompt = localStorage.getItem('gemini_system_prompt') || '–¢–∏ –∫–æ—Ä–∏—Å–Ω–∏–π AI –∞—Å–∏—Å—Ç–µ–Ω—Ç. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —á—ñ—Ç–∫–æ, —Å—Ç–∏—Å–ª–æ —Ç–∞ –ø–æ —Å—É—Ç—ñ. –ì–æ–≤–æ—Ä–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.';
    const deepseekPrompt = localStorage.getItem('deepseek_system_prompt') || '–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç-–ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç. –ü–∏—à–∏ —á–∏—Å—Ç–∏–π, –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏. –°—Ç–≤–æ—Ä—é–π –æ–∫—Ä–µ–º—ñ —Ñ–∞–π–ª–∏ –¥–ª—è HTML, CSS, JS. –ì–æ–≤–æ—Ä–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.';

    if (document.getElementById('geminiApiKey')) {
        document.getElementById('geminiApiKey').value = geminiKey;
    }
    if (document.getElementById('groqApiKey')) {
        document.getElementById('groqApiKey').value = groqKey;
    }
    if (document.getElementById('geminiSystemPrompt')) {
        document.getElementById('geminiSystemPrompt').value = geminiPrompt;
    }
    if (document.getElementById('deepseekSystemPrompt')) {
        document.getElementById('deepseekSystemPrompt').value = deepseekPrompt;
    }
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
function saveSettings() {
    const geminiKey = document.getElementById('geminiApiKey').value.trim();
    const groqKey = document.getElementById('groqApiKey').value.trim();
    const geminiPrompt = document.getElementById('geminiSystemPrompt').value.trim();
    const deepseekPrompt = document.getElementById('deepseekSystemPrompt').value.trim();

    localStorage.setItem('gemini_api_key', geminiKey);
    localStorage.setItem('groq_api_key', groqKey);
    localStorage.setItem('gemini_system_prompt', geminiPrompt);
    localStorage.setItem('deepseek_system_prompt', deepseekPrompt);

    alert('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
}

// –û—á–∏—â–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö
function clearAllData() {
    if (confirm('‚ö†Ô∏è –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ (—ñ—Å—Ç–æ—Ä—ñ—é, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –∫–ª—é—á—ñ)? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!')) {
        localStorage.clear();
        geminiHistory = [];
        deepseekHistory = [];
        codeFiles = {};
        
        document.getElementById('geminiMessages').innerHTML = '';
        document.getElementById('deepseekMessages').innerHTML = '';
        document.getElementById('fileTabs').innerHTML = '';
        document.getElementById('codeContent').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <h3>–ù–µ–º–∞—î —Ñ–∞–π–ª—ñ–≤</h3>
                <p>–ö–æ–¥ –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ AI</p>
            </div>
        `;
        
        loadSettings();
        alert('üóëÔ∏è –í—Å—ñ –¥–∞–Ω—ñ –≤–∏–¥–∞–ª–µ–Ω–æ!');
    }
}

// –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤
function switchMode(mode) {
    currentMode = mode;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.menu-btn').classList.add('active');
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É
    document.querySelectorAll('.mode-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${mode}Mode`).classList.add('active');
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–ª—ñ–≤ –≤–≤–æ–¥—É
function initializeInputs() {
    const inputs = ['geminiInput', 'deepseekInput'];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (inputId === 'geminiInput') {
                    sendGeminiMessage();
                } else if (inputId === 'deepseekInput') {
                    sendDeepseekMessage();
                }
            }
        });
    });
}

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç
function addMessage(text, sender, messagesId) {
    const messagesDiv = document.getElementById(messagesId);
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.textContent = text || '(–ö–æ–¥ —É –ø—Ä–∞–≤—ñ–π –ø–∞–Ω–µ–ª—ñ)';
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Gemini Message
async function sendGeminiMessage() {
    const input = document.getElementById('geminiInput');
    const message = input.value.trim();
    
    if (!message) return;

    const apiKey = localStorage.getItem('gemini_api_key');
    if (!apiKey) {
        alert('‚ö†Ô∏è –í–≤–µ–¥–∏ Gemini API –∫–ª—é—á —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö!');
        switchMode('settings');
        return;
    }

    input.value = '';
    input.style.height = 'auto';

    addMessage(message, 'user', 'geminiMessages');
    geminiHistory.push({ role: 'user', parts: [{ text: message }] });

    // –û–±–º–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –¥–æ 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    if (geminiHistory.length > 10) {
        geminiHistory = geminiHistory.slice(-10);
    }

    const sendBtn = document.getElementById('geminiSendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';

    try {
        const systemPrompt = localStorage.getItem('gemini_system_prompt') || '–¢–∏ –∫–æ—Ä–∏—Å–Ω–∏–π AI –∞—Å–∏—Å—Ç–µ–Ω—Ç.';
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: geminiHistory,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 2048
                }
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || '–ü–æ–º–∏–ª–∫–∞ API');
        }

        const aiMessage = data.candidates[0].content.parts[0].text;
        
        geminiHistory.push({ role: 'model', parts: [{ text: aiMessage }] });
        addMessage(aiMessage, 'assistant', 'geminiMessages');

    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        addMessage('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message, 'assistant', 'geminiMessages');
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏';
    }
}

// DeepSeek Message
async function sendDeepseekMessage() {
    const input = document.getElementById('deepseekInput');
    const message = input.value.trim();
    
    if (!message) return;

    const apiKey = localStorage.getItem('groq_api_key');
    if (!apiKey) {
        alert('‚ö†Ô∏è –í–≤–µ–¥–∏ Groq API –∫–ª—é—á —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö!');
        switchMode('settings');
        return;
    }

    input.value = '';
    input.style.height = 'auto';

    addMessage(message, 'user', 'deepseekMessages');
    
    const systemPrompt = localStorage.getItem('deepseek_system_prompt') || '–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç-–ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç.';
    
    deepseekHistory.push({ role: 'user', content: message });

    // –û–±–º–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –¥–æ 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    if (deepseekHistory.length > 20) {
        deepseekHistory = deepseekHistory.slice(-20);
    }

    const sendBtn = document.getElementById('deepseekSendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';

    try {
        const messages = [
            { role: 'system', content: systemPrompt },
            ...deepseekHistory
        ];

        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'llama-3.3-70b-versatile',
                messages: messages,
                temperature: 0.7,
                max_tokens: 4000
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || `–ü–æ–º–∏–ª–∫–∞ API: ${response.status}`);
        }

        const aiMessage = data.choices[0].message.content;
        
        deepseekHistory.push({ role: 'assistant', content: aiMessage });
        
        const textOnly = removeCodeBlocks(aiMessage);
        addMessage(textOnly, 'assistant', 'deepseekMessages');
        
        extractAndDisplayCode(aiMessage);

    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        addMessage('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message, 'assistant', 'deepseekMessages');
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏';
    }
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è –±–ª–æ–∫—ñ–≤ –∫–æ–¥—É –∑ —Ç–µ–∫—Å—Ç—É
function removeCodeBlocks(text) {
    return text.replace(/```[\s\S]*?```/g, '').trim();
}

// –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É
function extractAndDisplayCode(text) {
    const codeBlockRegex = /```(\w+)?\s*\n([\s\S]*?)```/g;
    let match;
    let fileIndex = Object.keys(codeFiles).length;
    
    while ((match = codeBlockRegex.exec(text)) !== null) {
        const lang = match[1] || 'txt';
        const code = match[2].trim();
        
        let filename = detectFilename(code, lang);
        
        if (!filename) {
            fileIndex++;
            filename = `file_${fileIndex}.${getExtension(lang)}`;
        }
        
        codeFiles[filename] = {
            language: lang,
            code: code
        };
    }
    
    if (Object.keys(codeFiles).length > 0) {
        displayCodeFiles();
    }
}

// –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É –∑ –∫–æ–¥—É
function detectFilename(code, lang) {
    const lines = code.split('\n');
    for (let line of lines.slice(0, 5)) {
        if (line.includes('<!DOCTYPE') || line.includes('<html')) return 'index.html';
        if (line.includes('def ') && lang === 'python') return 'main.py';
        if (line.includes('function ') || line.includes('const ') || line.includes('let ')) return 'script.js';
    }
    return null;
}

// –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É –∑–∞ –º–æ–≤–æ—é
function getExtension(lang) {
    const extensions = {
        'javascript': 'js',
        'python': 'py',
        'html': 'html',
        'css': 'css',
        'java': 'java',
        'cpp': 'cpp',
        'c': 'c',
        'go': 'go',
        'rust': 'rs',
        'php': 'php',
        'ruby': 'rb',
        'swift': 'swift',
        'kotlin': 'kt',
        'typescript': 'ts',
        'json': 'json'
    };
    return extensions[lang.toLowerCase()] || 'txt';
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑ –∫–æ–¥–æ–º
function displayCodeFiles() {
    const tabsDiv = document.getElementById('fileTabs');
    const contentDiv = document.getElementById('codeContent');
    
    tabsDiv.innerHTML = '';
    contentDiv.innerHTML = '';
    
    const filenames = Object.keys(codeFiles);
    
    filenames.forEach((filename, index) => {
        const tab = document.createElement('div');
        tab.className = 'file-tab' + (index === 0 ? ' active' : '');
        tab.textContent = filename;
        tab.onclick = () => switchFile(filename);
        tabsDiv.appendChild(tab);
        
        const fileDiv = document.createElement('div');
        fileDiv.className = 'code-file' + (index === 0 ? ' active' : '');
        fileDiv.dataset.filename = filename;
        
        const file = codeFiles[filename];
        fileDiv.innerHTML = `
            <div class="code-block">
                <div class="code-block-header">
                    <div class="code-block-info">
                        <span class="code-block-lang">${file.language}</span>
                        <span class="code-block-name">${filename}</span>
                    </div>
                    <div>
                        <button onclick="copyCode('${filename}')">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                        <button onclick="downloadFile('${filename}')">üíæ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                    </div>
                </div>
                <pre><code id="code-${filename}">${escapeHtml(file.code)}</code></pre>
            </div>
        `;
        
        contentDiv.appendChild(fileDiv);
    });
    
    activeFile = filenames[0];
}

// –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –º—ñ–∂ —Ñ–∞–π–ª–∞–º–∏
function switchFile(filename) {
    document.querySelectorAll('.file-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent === filename) {
            tab.classList.add('active');
        }
    });
    
    document.querySelectorAll('.code-file').forEach(file => {
        file.classList.remove('active');
        if (file.dataset.filename === filename) {
            file.classList.add('active');
        }
    });
    
    activeFile = filename;
}

// –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–æ–¥—É –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É
function copyCode(filename) {
    const code = document.getElementById(`code-${filename}`).textContent;
    navigator.clipboard.writeText(code).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
    });
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
function downloadFile(filename) {
    const code = codeFiles[filename].code;
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
